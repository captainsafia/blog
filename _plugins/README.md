# Jekyll Plugins for 404 Redirect Fixes

This directory contains custom Jekyll plugins that fix 404 errors reported in Google Search Console for blog.safia.rocks.

## How Jekyll Plugins Work

Jekyll automatically loads and executes any Ruby files (`.rb`) placed in the `_plugins` directory during the build process. Here's how it works:

1. **Automatic Discovery**: When you run `jekyll build` or `jekyll serve`, Jekyll scans the `_plugins` directory and loads all `.rb` files.

2. **Plugin Types**: There are several types of Jekyll plugins:
   - **Generators** (like `RedirectGenerator`): Run during the build to create new content or modify the site
   - **Converters**: Transform content from one format to another
   - **Commands**: Add new subcommands to the `jekyll` executable
   - **Tags**: Add custom Liquid tags
   - **Filters**: Add custom Liquid filters
   - **Hooks**: Execute code at specific points in the build process

3. **Execution Order**: Generators have a `priority` attribute (`:lowest`, `:low`, `:normal`, `:high`, `:highest`) that determines when they run relative to other generators.

4. **Integration**: Plugins extend Jekyll's built-in classes (like `Jekyll::Generator`, `Jekyll::Page`) and are automatically integrated into the build pipeline.

## Plugins in This Directory

### `redirect_generator.rb`
A Generator plugin that creates HTML redirect pages for old URLs.
- **Priority**: `:low` (runs after most content generation)
- **Output**: 631+ redirect pages in `_site/`

### `og_image_cleanup.rb`
A Generator plugin that filters out malformed OG image URLs.
- **Priority**: `:lowest` (runs after OG image generation)
- **Output**: Cleaned site.pages and site.static_files collections

---

## 404 Redirect Fixes Overview

This document describes the fixes implemented to resolve 404 errors reported in Google Search Console for blog.safia.rocks.

## Issues Identified

From the Google Search Console report dated 2025-12-27, there were **167 pages not indexed** due to various 404 errors:

1. **62 pages**: Not found (404)
2. **45 pages**: Discovered but not indexed
3. **24 pages**: Crawled but not indexed
4. **17 pages**: Alternate pages with proper canonical tags
5. **9 pages**: Duplicate without user-selected canonical
6. **9 pages**: Pages with redirects
7. **1 page**: Google chose different canonical than user

### Root Causes

1. **Malformed OG Image URLs**: The `jekyll-og-image` plugin was generating URLs with Ruby hash syntax instead of actual paths (e.g., `https://blog.safia.rocks/{"path" => "/assets/images/og/posts/..."}`)

2. **Old Tumblr URLs**: Legacy Tumblr post URLs were not being redirected to new Jekyll URLs
   - Format: `/post/{ID}/{slug}`
   - Format: `/post/{ID}/{slug}/embed`

3. **Legacy HTML Extension URLs**: Old URLs with date-slug format weren't redirecting to current pretty URLs
   - Format: `/YYYY-MM-DD-slug/`

4. **Build Artifacts in URLs**: Malformed paths containing `_posts` directories or `.md` extensions
   - Format: `/path/_posts/YYYY/YYYY-MM-DD-slug.md`
   - Format: `/YYYY/MM/DD/YYYY/YYYY-MM-DD-slug.md` (nested dates)

5. **Miscellaneous Pages**: `/ask`, `/past`, `/rss`, `/page2`, `/brief`, `/cdn-cgi/l/email-protection`

## Solutions Implemented

### 1. Jekyll Redirect Generator Plugin
**File**: `_plugins/redirect_generator.rb`

This plugin automatically generates HTML redirect pages for:
- All Tumblr post URLs (extracted from post front matter `tumblr_url`)
- Legacy date-slug format URLs
- Manual redirects for specific problematic URLs

The plugin generates **631 redirect pages** covering all known problematic URL patterns.

### 2. OG Image Cleanup Plugin
**File**: `_plugins/og_image_cleanup.rb`

This plugin filters out malformed URLs containing Ruby hash syntax that were being generated by the `jekyll-og-image` plugin. It runs after OG image generation and removes any pages or static files with malformed URLs from the site build.

### 3. Enhanced 404 Page
**File**: `404.html`

Added client-side JavaScript to handle edge cases:
- Malformed OG image URLs with hash syntax
- URLs ending in `.md`
- URLs containing `_posts` directories
- Nested date directories
- Query parameters (ref, utm_source) that should be stripped
- Redirect `/brief` to main site

### 4. Redirect Layout Template
**File**: `_layouts/redirect.html`

A simple HTML template used by redirect pages that:
- Sets canonical URL
- Uses meta refresh redirect
- Provides JavaScript fallback
- Includes `noindex` robots meta tag

## Testing

To test the fixes locally:

```bash
bundle install
bundle exec jekyll build
bundle exec jekyll serve
```

Then verify redirects work:
- Visit `http://localhost:4000/post/136973747045/` → should redirect to `/2016/01/09/thanks-for-the-compliment/`
- Visit `http://localhost:4000/ask` → should redirect to home
- Visit `http://localhost:4000/combing-through-component-base` → should redirect to `/2020/10/14/combing-through-component-base/`
- Visit `http://localhost:4000/rolling-in-render-trees.html` → should redirect to `/2020/10/26/rolling-in-render-trees/`

## Deployment

The fixes are deployed via GitHub Actions when pushed to the main branch. The workflow already handles two builds to work around jekyll-og-image issues.

## Expected Results

After deployment, Google Search Console should show:
- Reduced 404 errors from 62 to near-zero
- Old Tumblr URLs properly redirecting with 301 status
- Malformed OG image URLs no longer appearing in crawl reports
- Improved indexing rate for valid pages

## Monitoring

Check Google Search Console after 1-2 weeks to verify:
1. 404 count has decreased significantly
2. Redirect pages are not being indexed (they have noindex tags)
3. Canonical pages show improved indexing status
